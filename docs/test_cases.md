# Архитектура сервиса Авторизации
Сервис Авторизации состоит из 3х Докер контейнеров:
1. Web-сервер на Flask. Предоставляет API для работы с Сервисом
2. PostgreSQL. Хранит данные Пользователя, его Роли, историю логинов, список активных refresh-токенов
3. Redis. Хранит Black-лист access-токенов. Т.е. токенов у которых ещё не вышло время жизни, но они больше не валидны. Например, был /logout или обновление, или выход из других устройств.

Сервис Авторизации связан с другими Сервисами через API. Другие сервисы могут напрямую обращаться к сервису Авторизации. Для внешнего пользователя, все API будут объеденены единой точкой входа, - Nginx (уже существует и используется).

# JWT токены
- access-токен - короткоживущий токен в формате JWT. Время жизни - 10 минут. Используется для авторизации пользователя. В payload содержит `jti` (идентификатор пары токенов), `userID` (идентификатор Пользователя) и `roles` (список Ролей Пользователя).
- refresh-токен - долгоживущий токен в формате JWT. Время жизни - 30 дней. Используется для обновления access-токена. После каждого обновления access-токена, refresh-токен так же обновляется. В payload содержит `jti` (идентификатор пары токенов), `userID` (идентификатор Пользователя).

Перед генерацией пары access-refresh токенов создаётся идентификатор `jti`. Это рандомный идентификатор в формате UUID4. Этот идентификатор позволит нам безопастно объеденить пары токенов на Сервере.

# Пользовательские кейсы:
1 Зарегистрироваться
2 Залогиниться (аутентификация)
3 Запросить список фильмов, имеющий ограничение по Роли (авторизация)
4 Подождать завершения времени действия access-токена и запросить список фильмов, имеющий ограничение по Роли
5 Обновить access-токен
6 Выйти со всех устройств
7 Разлогиниться
8 Проверить отсутствие возможности выполнить запрос с авторизацией по имеющемуся access-токену
9 Проверить отсутствие возможности выполнить обновление access-токена по имеющемуся refresh-токену
10 Запросить список фильмов (неавторизованным пользователем)

# Подробное описание пользовательских кейсов

## 1. Зарегистрироваться (POST /user)

- ввести уникальный логин и пароль,
- получить статус 200

## 2. Залогиниться (POST /login)

- ввести логин и пароль зарегистрированного пользователя
- получить два jwt-токена (access и refresh)

## 3. Запросить список фильмов, имеющий ограничение по Роли (GET /api/v1/film)

- выполнить запрос к эндпоинту с заголовком `Authorization: Bearer <access-token>`
- получить список фильмов, ограниченный Ролью пользователя

## 4. Подождать завершения времени действия access-токена и запросить список фильмов, имеющий ограничение по Роли (GET /api/v1/film)

- выполнить запрос к эндпоинту с заголовком `Authorization: Bearer <access-token>`
- получить статус 401

## 5. Обновить access-токен (PUT /me/refresh_token)

- выполнить анонимный запрос к эндпоинту, т.е. без указания access-токена
- передать в теле запроса refresh-токен
- получить в ответ новый access-токен и новый refresh-токен
- в новом access-токене должен быть актуальный набор Ролей Пользователя

## 6. Выйти со всех устройств, кроме текущего (GET /me/logout_other_devices)

- выполнить запрос к эндпоинту с заголовком `Authorization: Bearer <access-token>`
- получить статус 200
- после этого, Пользователь не должен иметь возможность выполнять авторизованный доступ на всех устройствах, кроме текущего. Другими словами, другие пары access/refresh-токенов должны стать невалидными.

## 7. Разлогиниться (GET /me/logout)

- выполнить запрос к эндпоинту с заголовком `Authorization: Bearer <access-token>`
- Получить статус 200
- после этого, Пользователь не должен иметь возможность выполнять авторизованный доступ на данном устройстве, т.е. с текущей парой access/refresh-токенов

## 8. Проверить отсутствие возможности выполнить запрос с авторизацией по имеющемуся access-токену (GET /api/v1/film)

- выполнить запрос к эндпоинту с заголовком `Authorization: Bearer <access-token>`. access-токен тот же, что использовался для Разлогина
- получить список фильмов, доступных анонимному пользователю

## 9. Проверить отсутствие возможности выполнить обновление access-токена по имеющемуся refresh-токену (PUT /me/refresh_token)

- выполнить анонимный запрос к эндпоинту, т.е. без указания access-токена
- передать в теле запроса refresh-токен; refresh-токен тот же, что был в паре с тем access-токеном, который использовался для Разлогина
- получить статус 401

## 10. Запросить список фильмов (неавторизованным пользователем) (GET /api/v1/film)

- выполнить анонимный запрос к эндпоинту, т.е. без указания access-токена
- получить список фильмов, доступных анонимному пользователю